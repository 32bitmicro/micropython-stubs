########################################################################################################################################
# This will attempt to retrieve and generate stubs from all known versions of MicroPython
########################################################################################################################################
# Check out repos in this structure 
# micropython-stubs
#   + - stubs 
#   +-- micropython-stubber
#       +-- micropython
#        -- micropython-lib
# repro structure needed to allow automatic PR creation to work
########################################################################################################################################
name: get-loboris-frozen

on:
  workflow_dispatch:
  # not maintained- no need to try to update all the time 
  # schedule: 
  #   - cron: "0 1 * * *"   # Run everyday at 01:00

jobs:
  ########################################################################################################################################
  get-loboris-frozen-stubs:
    runs-on: ubuntu-latest

    # Most scripts will be run from the stubber, set that as default
    defaults:
      run:
        shell: bash
        working-directory: ${{github.workspace}}/micropython-stubber
    
    steps:

      - name: Checkout stubs repo
        uses: actions/checkout@v2

      - name: Checkout Stubber
        uses: actions/checkout@v2
        with:
          repository: josverl/micropython-stubber
          path: micropython-stubber

      # make Python work
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.9

      #----------------------------------------------
      # poetry is not in the default image
      #----------------------------------------------
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true

      #----------------------------------------------
      # install dependencies 
      #----------------------------------------------
      - name: Install dependencies
        run: poetry install --no-interaction --no-root

      #----------------------------------------------
      # install root project Pymakr
      #----------------------------------------------
      - name: Install library stubber
        run: poetry install --no-interaction

      ######################################
      # This is where the actual work starts
      ######################################

      - name: Get frozen modules for ${{ matrix.version }}
        working-directory: ${{github.workspace}}/micropython-stubber
        run: |
          poetry run get_frozen --stub-folder ${{github.workspace}}/stubs --lobo

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        id: cpr
        # ref: https://github.com/peter-evans/create-pull-request
        with:
          token: ${{ secrets.CREATE_PR_ACTION_TOKEN }} # ${{ secrets.PAT }}
          title: "add/update Loboris frozen stubs"
          commit-message: add/update Loboris frozen stubs
          branch: "micropython-lobo-stubs"
          labels: |
            frozen stubs
            Loboris
          delete-branch: true

      - name: Enable Pull Request Automerge
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: peter-evans/enable-pull-request-automerge@v1
        with:
          token: ${{ secrets.CREATE_PR_ACTION_TOKEN }} # ${{ secrets.PAT }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash
  ########################################################################################################################################

